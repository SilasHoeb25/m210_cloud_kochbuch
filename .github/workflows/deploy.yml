name: Deploy Kochbuch

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy auf lokalen Docker
    runs-on: self-hosted

    # Secrets als Environment-Variablen im Job verf√ºgbar machen
    env:
      MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
      MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
      MYSQL_USER: ${{ secrets.MYSQL_USER }}
      MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}

    steps:
      - name: Code auschecken
        uses: actions/checkout@v4

      - name: .env Datei erzeugen
        shell: powershell
        run: |
          Set-Content -Path ".env" -Value "MYSQL_ROOT_PASSWORD=$env:MYSQL_ROOT_PASSWORD"
          Add-Content -Path ".env" -Value "MYSQL_DATABASE=$env:MYSQL_DATABASE"
          Add-Content -Path ".env" -Value "MYSQL_USER=$env:MYSQL_USER"
          Add-Content -Path ".env" -Value "MYSQL_PASSWORD=$env:MYSQL_PASSWORD"

      - name: Alte Docker-Container stoppen & entfernen
        shell: powershell
        run: |
          Write-Host "Stopping previous Docker containers (if any)..."
          docker compose down

      - name: Deployment starten (neu bauen & hochfahren)
        shell: powershell
        run: docker compose up --build -d




